name: Vercel Production Deploy

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: vercel-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      DISCORD_WEBHOOK_SUCCESS: ${{ secrets.DISCORD_WEBHOOK_SUCCESS }}
      DISCORD_WEBHOOK_FAIL: ${{ secrets.DISCORD_WEBHOOK_FAIL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: FrontEnd/package-lock.json

      - name: Cache frontend node_modules
        uses: actions/cache@v3
        with:
          path: FrontEnd/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('FrontEnd/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Validate required Vercel secrets
        shell: bash
        run: |
          # Normalize token to avoid hidden CR/LF from copy/paste in GitHub secrets.
          VERCEL_TOKEN_CLEAN="$(printf '%s' "$VERCEL_TOKEN" | tr -d '\r\n[:space:]')"
          if [ -z "$VERCEL_TOKEN_CLEAN" ]; then
            echo "::error::Missing VERCEL_TOKEN secret."
            exit 1
          fi
          if [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "::error::Missing VERCEL_PROJECT_ID secret."
            exit 1
          fi
          echo "VERCEL_TOKEN=$VERCEL_TOKEN_CLEAN" >> "$GITHUB_ENV"

      - name: Validate Vercel token and project access
        shell: bash
        run: |
          if ! curl -fsS -H "Authorization: Bearer $VERCEL_TOKEN" "https://api.vercel.com/v2/user" >/dev/null; then
            echo "::error::Invalid VERCEL_TOKEN. Create a new token in Vercel and update the GitHub secret."
            exit 1
          fi
          if ! curl -fsS -H "Authorization: Bearer $VERCEL_TOKEN" "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID" >/dev/null; then
            echo "::error::VERCEL_PROJECT_ID is invalid or this token cannot access that project."
            exit 1
          fi

      - name: Resolve Vercel org id
        shell: bash
        run: |
          if [ -n "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "VERCEL_ORG_ID=${{ secrets.VERCEL_ORG_ID }}" >> "$GITHUB_ENV"
          else
            account_id="$(
              curl -fsS \
                -H "Authorization: Bearer $VERCEL_TOKEN" \
                "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID" \
              | node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync(0,'utf8')); if(!data.accountId){process.exit(1)}; process.stdout.write(String(data.accountId));"
            )"
            echo "VERCEL_ORG_ID=$account_id" >> "$GITHUB_ENV"
          fi

      - name: Install frontend dependencies
        run: npm ci --prefix FrontEnd

      - name: Lint frontend
        run: npm run lint --prefix FrontEnd

      - name: Typecheck frontend
        run: npm run typecheck --prefix FrontEnd

      - name: Run frontend tests (if configured)
        run: npm run test --if-present --prefix FrontEnd

      - name: Build frontend
        run: npm run build --prefix FrontEnd

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Pull Vercel project settings
        run: vercel pull --yes --environment=production --scope="$VERCEL_ORG_ID" --token="$VERCEL_TOKEN"

      - name: Build Vercel output
        run: vercel build --prod --scope="$VERCEL_ORG_ID" --token="$VERCEL_TOKEN"

      - name: Deploy to Vercel production
        run: vercel deploy --prebuilt --prod --scope="$VERCEL_ORG_ID" --token="$VERCEL_TOKEN"

      - name: Run Supabase migrations
        if: env.SUPABASE_ACCESS_TOKEN != ''
        run: npx supabase db push

      # Success notification
      - name: Notify Discord on success
        if: ${{ success() && env.DISCORD_WEBHOOK_SUCCESS != '' }}
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_SUCCESS }}
        with:
          args: "✅ Frontend deployed to Vercel Production successfully! (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>)"

      # Failure notification
      - name: Notify Discord on failure
        if: ${{ failure() && env.DISCORD_WEBHOOK_FAIL != '' }}
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FAIL }}
        with:
          args: "❌ Deployment FAILED! Check logs: (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>)"
